# Architecture Diagrams: AIDD MCP Ecosystem

> Mermaid diagrams for the AIDD MCP ecosystem plan.
> **Last Updated**: 2026-02-05

---

## 1. High-Level Architecture — Engine + Split

```mermaid
graph TB
    subgraph "AI Clients"
        CC[Claude Code]
        CU[Cursor]
        WS[Windsurf]
    end

    subgraph "Default: Engine (1 process)"
        direction TB
        ENG["@aidd.md/mcp-engine<br/>63 tools · 1 server"]

        subgraph "Core (Brain)"
            B1[Bootstrap]
            B2[Routing]
            B3[Knowledge]
            B4[Guidance]
            B5[Context]
            B6[Scaffold]
        end

        subgraph "Memory"
            M1[Session]
            M2[Branch]
            M3[Memory Search]
            M4[Observation]
            M5[Lifecycle]
            M6[Evolution]
            M7[Drafts]
            M8[Analytics]
            M9[Diagnostics]
        end

        subgraph "Tools (Hands)"
            T1[Validation<br/>11 validators]
            T2[Enforcement<br/>4 tools]
            T3[Execution<br/>2 tools]
            T4[CI<br/>2 tools]
        end
    end

    CC & CU & WS <-->|MCP Protocol<br/>stdio / HTTP| ENG

    style ENG fill:#bbf,stroke:#333,stroke-width:2px
    style B1 fill:#bfb,stroke:#333
    style M1 fill:#fbf,stroke:#333
    style T1 fill:#ffb,stroke:#333
```

---

## 2. Split Mode Architecture

```mermaid
graph TB
    AI[AI Client]

    subgraph "3 Separate MCP Servers"
        CORE["@aidd.md/mcp-core<br/>17 tools<br/>The Brain"]
        MEM["@aidd.md/mcp-memory<br/>27 tools<br/>The Memory"]
        TOOLS["@aidd.md/mcp-tools<br/>19 tools<br/>The Hands"]
    end

    SHARED["@aidd.md/mcp-shared<br/>Types · Factory · Utils"]

    AI <-->|MCP| CORE
    AI <-->|MCP| MEM
    AI <-->|MCP| TOOLS

    CORE -.->|depends on| SHARED
    MEM -.->|depends on| SHARED
    TOOLS -.->|depends on| SHARED

    style CORE fill:#bfb,stroke:#333,stroke-width:2px
    style MEM fill:#fbf,stroke:#333,stroke-width:2px
    style TOOLS fill:#ffb,stroke:#333,stroke-width:2px
    style SHARED fill:#ddd,stroke:#333
```

---

## 3. Package Dependency Graph

```mermaid
graph TD
    ENGINE["@aidd.md/mcp-engine"]
    CORE["@aidd.md/mcp-core"]
    MEM["@aidd.md/mcp-memory"]
    TOOLS["@aidd.md/mcp-tools"]
    SHARED["@aidd.md/mcp-shared"]
    CLI["@aidd.md/cli"]
    SQLITE[better-sqlite3<br/>optional]

    ENGINE -->|imports modules| CORE & MEM & TOOLS
    CORE --> SHARED
    MEM --> SHARED
    MEM -.->|optionalDep| SQLITE
    TOOLS --> SHARED
    CLI --> SHARED

    style ENGINE fill:#bbf,stroke:#333,stroke-width:2px
    style SHARED fill:#ddd,stroke:#333
    style SQLITE fill:#ffd,stroke:#333,stroke-dasharray:5
```

---

## 4. Storage Architecture (Hybrid)

```mermaid
graph TB
    subgraph "SQLite (.aidd/data.db)"
        direction TB
        S1[sessions]
        S2[observations]
        S3[tool_usage]
        S4[observations_fts<br/>FTS5]
        S5[permanent_memory_fts<br/>FTS5]
    end

    subgraph "JSON (Git-visible)"
        direction TB
        J1[ai/memory/decisions.json]
        J2[ai/memory/mistakes.json]
        J3[ai/memory/conventions.json]
        J4[.aidd/branches/*.json]
        J5[.aidd/evolution/log.json]
        J6[.aidd/evolution/pending.json]
        J7[.aidd/drafts/manifest.json]
    end

    subgraph "StorageBackend Interface"
        SB[StorageProvider<br/>lazy singleton]
    end

    SB -->|transient data| S1 & S2 & S3
    SB -->|search index| S4 & S5
    SB -.->|syncs on init| J1 & J2 & J3

    M1[Session Module] --> SB
    M2[Observation Module] --> SB
    M3[Memory Module] --> SB
    M4[Branch Module] -->|direct| J4
    M5[Evolution Module] -->|direct| J5 & J6
    M6[Drafts Module] -->|direct| J7

    style S1 fill:#bbf
    style S4 fill:#bbf
    style J1 fill:#bfb
    style J4 fill:#bfb
    style SB fill:#ffd,stroke:#333,stroke-width:2px
```

---

## 5. 5-Layer Memory Model

```mermaid
graph TB
    subgraph "Layer 5: EVOLUTION"
        E[Cross-session patterns<br/>.aidd/evolution/]
    end

    subgraph "Layer 4: PERMANENT"
        P[Project lifetime<br/>ai/memory/*.json]
    end

    subgraph "Layer 3: LIFECYCLE"
        L[Feature/task lifecycle<br/>AIDD 6 phases]
    end

    subgraph "Layer 2: BRANCH"
        B[Git branch scope<br/>.aidd/branches/]
    end

    subgraph "Layer 1: SESSION"
        S[Single conversation<br/>.aidd/sessions/]
    end

    S -->|"promote on end"| B
    B -->|"promote on merge"| P
    P -->|"patterns detected"| E
    L -->|"phase completion"| P

    style E fill:#f9f,stroke:#333,stroke-width:2px
    style P fill:#bfb,stroke:#333,stroke-width:2px
    style L fill:#bbf,stroke:#333
    style B fill:#ffb,stroke:#333
    style S fill:#fdd,stroke:#333
```

---

## 6. 3-Layer Search Pattern

```mermaid
sequenceDiagram
    participant AI as AI Client
    participant L1 as aidd_memory_search
    participant L2 as aidd_memory_context
    participant L3 as aidd_memory_get
    participant DB as StorageBackend

    Note over AI,DB: Layer 1 — Compact Index (~50-100 tokens/result)
    AI->>L1: search("authentication bug")
    L1->>DB: FTS5 query
    DB-->>L1: 8 matches
    L1-->>AI: [{id, title, snippet, score}] × 8

    Note over AI: AI filters: 3 of 8 look relevant

    Note over AI,DB: Layer 2 — Timeline Context (optional)
    AI->>L2: context(anchorId="mem_042")
    L2->>DB: fetch neighbors by timestamp
    DB-->>L2: anchor + 2 before + 2 after
    L2-->>AI: {anchor, before[], after[]}

    Note over AI: AI confirms: 2 entries worth reading in full

    Note over AI,DB: Layer 3 — Full Details (~500-1000 tokens/result)
    AI->>L3: get(["mem_042", "mem_038"])
    L3->>DB: batch fetch
    DB-->>L3: full entries
    L3-->>AI: [{id, content, facts, narrative, ...}] × 2

    Note over AI,DB: Result: 2 full entries instead of 8<br/>~1500 tokens vs ~6000 tokens
```

---

## 7. Content Loading Pipeline

```mermaid
graph LR
    subgraph "Build Time"
        SRC[aidd.md repo<br/>AGENTS.md, rules/,<br/>skills/, workflows/,<br/>specs/, knowledge/]
        SCRIPT[bundle-content.ts]
        PKG[npm package<br/>content/bundled/]
    end

    subgraph "Runtime"
        DETECT[Project Detector<br/>scan for AIDD files]
        PROJ[Project Files<br/>rules/, skills/, etc.]
        MERGE[ContentLoader<br/>merge strategy]
        TOOLS2[Registered Tools<br/>+ Resources + Prompts]
    end

    SRC --> SCRIPT --> PKG
    PKG --> MERGE
    DETECT --> PROJ --> MERGE
    MERGE --> TOOLS2

    style PKG fill:#bbf
    style PROJ fill:#bfb
    style MERGE fill:#ffd,stroke:#333,stroke-width:2px
```

---

## 8. Module Registration Flow

```mermaid
sequenceDiagram
    participant Main as index.ts
    participant Factory as createAiddServer()
    participant Server as McpServer
    participant Mod as AiddModule
    participant Ctx as ModuleContext

    Main->>Factory: createAiddServer(config)
    Factory->>Server: new McpServer(name, version)
    Factory->>Ctx: build context<br/>(contentLoader, projectInfo, config, logger)

    loop For each module
        Factory->>Mod: module.register(server, context)
        Mod->>Server: server.tool(name, schema, handler)
        Mod->>Server: server.resource(uri, handler)
        Mod->>Server: server.prompt(name, handler)
    end

    loop For each module with onReady
        Factory->>Mod: module.onReady(context)
        Note over Mod: Initialize storage,<br/>load caches, etc.
    end

    Factory-->>Main: {server, cleanup}
```

---

## 9. Tool Inventory Distribution

```mermaid
pie title 63 Tools by Package
    "Core (Brain)" : 17
    "Memory" : 27
    "Tools (Hands)" : 19
```

---

## 10. Evolution Engine Flow

```mermaid
graph TD
    SESS[Completed Sessions] --> REC[Record Instrumentation<br/>agents, skills, tools,<br/>model, rules, outcome]

    REC --> PAT[Pattern Recognition<br/>4 detectors]

    PAT --> D1[Model Performance<br/>by task type]
    PAT --> D2[Recurring Mistakes<br/>→ draft new rule]
    PAT --> D3[Tool Sequences<br/>→ compound workflow]
    PAT --> D4[Skill Combos<br/>→ update agent skills]

    D1 & D2 & D3 & D4 --> CONF{Confidence<br/>Score}

    CONF -->|">90%, 10+ sessions"| AUTO[Auto-Apply<br/>+ notify user]
    CONF -->|"70-90%, 5-10 sessions"| DRAFT[Draft in<br/>.aidd/drafts/]
    CONF -->|"<70%, <5 sessions"| PEND[Log to<br/>pending.json]

    AUTO --> LOG[Audit Trail<br/>evolution/log.json]
    AUTO --> SNAP[Snapshot<br/>for rollback]

    style AUTO fill:#bfb,stroke:#333
    style DRAFT fill:#ffb,stroke:#333
    style PEND fill:#fdd,stroke:#333
    style LOG fill:#ddd,stroke:#333
```
