# Architecture Diagrams: Hub Memory Service â€” DDD + Hexagonal

> Mermaid diagrams for the Hub memory bounded context.
> **Last Updated**: 2026-02-07

---

## 1. Hexagonal Architecture (Layers)

```mermaid
graph TB
    subgraph "Presentation Layer"
        TC[Tauri Commands<br/>memory_commands.rs]
    end

    subgraph "Application Layer"
        MS[MemoryService<br/>memory_service.rs]
    end

    subgraph "Domain Layer"
        MP[MemoryPort trait<br/>memory_port.rs]
        VO[Value Objects<br/>SessionSummary, EvolutionStatus<br/>PatternStats, ObservationEntry]
    end

    subgraph "Infrastructure Layer"
        SMA[SqliteMemoryAdapter<br/>sqlite_memory_adapter.rs]
        MMA[McpMemoryAdapter<br/>mcp_memory_adapter.rs<br/>stub]
    end

    subgraph "External"
        DB[(data.db<br/>SQLite)]
        PS[ProjectService<br/>active project path]
        ENG[MCP Engine<br/>future JSON-RPC]
    end

    TC --> MS
    MS --> MP
    SMA -.->|implements| MP
    MMA -.->|implements| MP
    SMA --> DB
    SMA --> PS
    MMA -.->|future| ENG

    style MP fill:#f9f,stroke:#333,stroke-width:2px
    style DB fill:#bbf,stroke:#333,stroke-width:2px
    style MS fill:#bfb,stroke:#333,stroke-width:2px
```

---

## 2. Data Flow (Request Lifecycle)

```mermaid
sequenceDiagram
    participant UI as React Frontend
    participant TC as Tauri Command
    participant MS as MemoryService
    participant SMA as SqliteMemoryAdapter
    participant PS as ProjectService
    participant DB as data.db

    UI->>TC: invoke('get_sessions')
    TC->>MS: get_session_summary()
    MS->>SMA: get_session_summary()
    SMA->>PS: get_active_path()
    PS-->>SMA: "/path/to/project"
    SMA->>DB: SELECT COUNT(*) FROM sessions
    DB-->>SMA: rows
    SMA-->>MS: SessionSummary
    MS-->>TC: SessionSummary
    TC-->>UI: JSON response
```

---

## 3. Dependency Direction (Clean Architecture Rule)

```mermaid
graph LR
    subgraph "Dependencies flow INWARD"
        direction LR
        P[Presentation] --> A[Application]
        A --> D[Domain]
        I[Infrastructure] --> D
    end

    style D fill:#f9f,stroke:#333,stroke-width:3px
    style A fill:#bfb,stroke:#333,stroke-width:2px
    style P fill:#bbf,stroke:#333,stroke-width:1px
    style I fill:#fbb,stroke:#333,stroke-width:1px
```

**Rule**: Domain has zero dependencies. Everything points inward.

---

## 4. Adapter Selection (Runtime)

```mermaid
graph TD
    A[lib.rs startup] --> B{Which adapter?}
    B -->|Current| C[SqliteMemoryAdapter]
    B -->|Future| D[McpMemoryAdapter]
    C --> E[Box dyn MemoryPort]
    D --> E
    E --> F[MemoryService]
    F --> G[AppContext]
    G --> H[Tauri managed state]
```

---

## 5. Frontend Store (Zustand)

```mermaid
stateDiagram-v2
    [*] --> Stale
    Stale --> Loading: fetch()
    Loading --> Loaded: success
    Loading --> Error: failure
    Loaded --> Stale: invalidate() or 60s elapsed
    Error --> Loading: retry
    Loaded --> Loading: forceRefresh
```

Cache: 60-second TTL. Graceful fallback on all errors.
