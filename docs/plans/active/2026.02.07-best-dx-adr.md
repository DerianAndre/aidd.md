# ADR: Best DX — Zero-Friction Developer Experience

> Architecture Decision Record
> **Date**: 2026-02-07
> **Status**: Accepted
> **Deciders**: Project Lead + AI Architect

---

## Context

The AIDD MCP ecosystem (69 tools, 5 packages) requires manual setup steps beyond `pnpm install`:
1. `pnpm mcp:setup` — builds packages + creates `.aidd/`
2. `aidd integrate claude` / `aidd integrate cursor` — manual per-IDE configuration
3. User must know which IDEs they have and configure each one

This multi-step process creates friction for both:
- **Contributors** cloning the repo to develop the framework
- **Adopters** using AIDD in their own projects

Additionally, the MCP config always uses `npx @aidd.md/mcp-engine`, which is slow (~3-5s cold start) and requires npm registry access — suboptimal for contributors who have the packages built locally.

## Decision

### 1. Unified `pnpm setup` Command

**Expand the setup script to handle everything** — build, init, IDE detection, configuration, verification — in a single command.

- `pnpm setup` as the primary command, `pnpm mcp:setup` as alias
- 7 steps instead of 4: add IDE detection, doctor, summary
- Install ALL workspace deps (not just mcps/packages), future-proofing for Hub

**Why not keep it separate?**
- Every manual step is a potential drop-off point
- IDE integration is essential (without it, MCPs don't auto-start)
- The setup script already runs the doctor — might as well include integration

### 2. Interactive IDE Confirmation

**Detect IDEs automatically but ask before writing config files.**

Flow: detect → show list → `Configure these IDEs? [Y/n]` → write on confirmation.

**Why interactive, not silent?**
- Writing to `~/.claude/mcp.json` (global) affects all Claude Code sessions
- Users may have existing MCP configs they don't want modified
- "Detect and confirm" is the respectful default — power users can script `yes | pnpm setup`

### 3. Smart MCP Path Detection

**Use local build path for contributors, npx for adopters.**

Detection: `existsSync(join(root, 'mcps/mcp-aidd-engine/dist/index.js'))`
- If exists → contributor mode → `node <abs-path>/dist/index.js` (fast, offline)
- If not → adopter mode → `npx -y @aidd.md/mcp-engine` (portable)

**Why not always use npx?**
- `npx` resolves from npm registry — adds 3-5s cold start
- Contributors have the package built locally — `node dist/index.js` starts in <1s
- Offline-friendly: no registry access needed during development

**Why not always use local path?**
- Breaks if user moves the repo (absolute path in config)
- Adopters don't have the mcps/ directory in their project
- `npx` is the standard MCP distribution mechanism

### 4. Config Merge Strategy

**Read existing config, merge `aidd-engine` entry, preserve everything else.**

```javascript
config.mcpServers['aidd-engine'] = mcpEntry;  // only touch our entry
```

**Why merge, not overwrite?**
- Users have other MCP servers configured (context7, shadcn, etc.)
- Overwriting would break their existing setup
- Our entry has a stable key (`aidd-engine`) — safe to upsert

### 5. Both Entry Points for Adopters

**CLI (`npx @aidd.md/cli init`) and manual copy — both documented, neither gatekept.**

- CLI: automated, handles .aidd/ init + IDE integration
- Manual: copy AGENTS.md + content/ into project, run setup manually
- CLI is recommended; manual is for minimal adoption or offline environments

### 6. Turborepo Build Caching

**Add `turbo.json` for incremental builds.**

- Second `pnpm mcp:build` is near-instant (cache hit)
- Dependency graph ensures shared builds before mcps
- No behavioral change — just faster

## Consequences

### Positive
- Setup reduced from 3+ commands to 1 (`pnpm setup`)
- IDEs configured automatically with smart path detection
- Contributors get <1s MCP cold start (local build)
- Existing MCP configs preserved (merge strategy)
- Turbo caching makes rebuilds near-instant
- Both contributor and adopter paths are clear

### Negative
- Interactive prompt breaks non-interactive CI (workaround: `yes | pnpm setup` or skip step)
- Absolute paths in contributor configs break if repo moves (re-run setup)
- Turborepo adds ~15MB devDependency

### Risks
- IDE detection may miss edge cases (portable VS Code, non-standard Claude installs)
  - Mitigated by: `aidd integrate <tool>` still available for manual setup
- Config merge could conflict with unusual JSON structures
  - Mitigated by: try/catch with fallback to create new config

## Alternatives Considered

| Alternative | Why Rejected |
|------------|-------------|
| Auto-write without confirmation | Too invasive — modifies global config silently |
| Only support npx | 3-5s cold start penalty for contributors who build locally |
| Only support local path | Breaks for adopters who don't have mcps/ |
| Separate `pnpm integrate` command | Extra step = extra friction. Defeats "one command" goal |
| Detect IDEs via running processes | Unreliable — IDE may not be running during setup |
